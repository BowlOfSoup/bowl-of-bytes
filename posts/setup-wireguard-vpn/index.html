<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Setting up a VPN with WireGuard | Bowl Of Bytes</title>
<meta name="keywords" content="VPN, Linux, Homelab">
<meta name="description" content="In my project of building a homelab I wanted to set up a VPN to access my internal network from
anywhere. Read on to see how I&rsquo;ve set this up with Wireguard.">
<meta name="author" content="">
<link rel="canonical" href="https://bowlofbytes.com/posts/setup-wireguard-vpn/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://bowlofbytes.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://bowlofbytes.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://bowlofbytes.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://bowlofbytes.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://bowlofbytes.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://bowlofbytes.com/posts/setup-wireguard-vpn/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
    
        <link rel="stylesheet" href="/css/custom.css">
    
<meta property="og:url" content="https://bowlofbytes.com/posts/setup-wireguard-vpn/">
  <meta property="og:site_name" content="Bowl Of Bytes">
  <meta property="og:title" content="Setting up a VPN with WireGuard">
  <meta property="og:description" content="In my project of building a homelab I wanted to set up a VPN to access my internal network from anywhere. Read on to see how I’ve set this up with Wireguard.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-11-15T00:08:00+01:00">
    <meta property="article:modified_time" content="2024-11-15T00:08:00+01:00">
    <meta property="article:tag" content="VPN">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Homelab">
    <meta property="og:image" content="https://bowlofbytes.com/images/setup-wireguard-vpn.jpg">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://bowlofbytes.com/images/setup-wireguard-vpn.jpg">
<meta name="twitter:title" content="Setting up a VPN with WireGuard">
<meta name="twitter:description" content="In my project of building a homelab I wanted to set up a VPN to access my internal network from
anywhere. Read on to see how I&rsquo;ve set this up with Wireguard.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://bowlofbytes.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Setting up a VPN with WireGuard",
      "item": "https://bowlofbytes.com/posts/setup-wireguard-vpn/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Setting up a VPN with WireGuard",
  "name": "Setting up a VPN with WireGuard",
  "description": "In my project of building a homelab I wanted to set up a VPN to access my internal network from anywhere. Read on to see how I\u0026rsquo;ve set this up with Wireguard.\n",
  "keywords": [
    "VPN", "Linux", "Homelab"
  ],
  "articleBody": "In my project of building a homelab I wanted to set up a VPN to access my internal network from anywhere. Read on to see how I’ve set this up with Wireguard.\nThe plan Among other devices in my network I have a Synology NAS, which I don’t want to expose to the internet. But I do want to be able to connect to the NAS and work on my homelab servers from outside my home.\nI’ve chosen Wireguard to serve as my VPN protocol. It’s quite easy to set up and has apps available on mobile and desktop platforms. The only thing is, you will need a static public IP address to be able to connect. If you don’t have that you can either use a service like TailScale or a Dynamic DNS (DDNS) service.\nLet’s dive into setting up Wireguard on a Debian based system, in my case a Raspberry Pi. WireGuard is a lightweight, fast, and secure VPN protocol. You use it by installing the WireGuard app on your phone or laptop then importing a configuration file provided by the server. Now you’re ready to connect!\nWireguard installation → Install Wireguard.\nLet’s also install qrencode to generate a QR code for the mobile client, which can be scanned right off the terminal to add the VPN profile to the Wireguard app.\n1 sudo apt install wireguard qrencode -y → Create a private and public key for the server. Don’t share your private key with anyone.\n1 2 mkdir vpn \u0026\u0026 cd vpn wg genkey | tee server_privatekey | wg pubkey \u003e server_publickey A private and public key will also need to be generated for the every single client that connects via Wireguard. I tested this via my mobile phone with the Wireguard app.\n→ Create a private and public key for the mobile client.\n1 2 mkdir clients \u0026\u0026 cd clients wg genkey | tee phone_privatekey | wg pubkey \u003e phone_publickey Server configuration → Edit /etc/wireguard/wg0.conf and add the following configuration:\n1 2 3 4 5 6 7 8 9 10 [Interface] PrivateKey = Address = 10.7.70.5/24 ListenPort = 51820 PostUp = iptables -A FORWARD -i wg0 -o eth0 -j ACCEPT; iptables -A FORWARD -i eth0 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE PostDown = iptables -D FORWARD -i wg0 -o eth0 -j ACCEPT; iptables -D FORWARD -i eth0 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE [Peer] PublicKey = AllowedIPs = 10.7.70.0/24 Replace and with the keys you generated earlier. Double-check your network device name (eth0 in this case). Run ip a to confirm it. Your VPN subnet (10.7.70.0/24) must not clash with your home subnet. You can name the config anything instead of wg0. Just make sure you use that name everywhere instead. Server [Interface] PrivateKey Paste your generated private key here. Address Subnet for your VPN, make sure this is different than your home subnet. ListenPort Port for Wireguard to work on. PostUp Enable traffic forwarding and Network Address Translation; makes sure you can access your home subnet. PostUp Remove traffic forwarding and NAT, when disabling Wireguard. Server [Peer] PublicKey Paste your generated public key for your client, in our case ‘phone’ here. AllowedIPs Allowed IP’s to be assigned to client. Add multiple [Peer] sections for each client you want to connect to the VPN.\nClient specific configuration → Create a client configuration file, phone.conf in the already created clients directory.\n1 2 3 4 5 6 7 8 [Interface] PrivateKey = Address = 10.7.70.10/32 [Peer] PublicKey = Endpoint = :51820 AllowedIPs = 10.7.70.0/24, 192.168.0.0/24 ✅ This file is the one you have to distribute to your clients Wireguard app!\nClient [Interface] PrivateKey Paste your generated private key here, for your client (phone). Address Indicate the actual IP the client is going to be assigned to. Client [Peer] PublicKey Paste your generated public key for your client, in our case ‘phone’ here. Endpoint Put your IP or domain here. It’s your own (external) IP. AllowedIPs IP ranges reachable by the client. In this case the VPN subnet and the home subnet. Commands → Enable and start the Wireguard service based on you wg0 configuration file.\n1 2 sudo systemctl enable wg-quick@wg0 sudo systemctl start wg-quick@wg0 → Stop Wireguard for the wg0 configuration. This will reset the network configuration.\n1 sudo wg-quick down wg0 → Start Wireguard with the wg0 configuration\n1 sudo wg-quick up wg0 Generate a QR code to scan To be able to use the VPN on your mobile phone, install the Wireguard app. You can generate a QR code in the terminal with qrencode, open the app and scan the code to add the VPN profile.\n1 qrencode -t ansiutf8 \u003c clients/phone.conf Verifying and troubleshooting (1) Verify via your phone or device You should be able to connect from your phone to your internal network.\nTurn off Wi-Fi on your phone. Connect to the VPN (either by scanning the QR code on your phone or importing the configuration file). Try accessing your NAS or router’s web interface. (2) Check if the VPN still works after a reboot. 1 2 3 sudo reboot # ... sudo wg show (?) My VPN server is not reachable anymore This is mostly due to a mis-configuration in the IP ranges in the wg0.conf file.\nMake sure the internal subnet actually matches with yours. Double check if the VPN subnet is different from the internal one. ",
  "wordCount" : "935",
  "inLanguage": "en",
  "image":"https://bowlofbytes.com/images/setup-wireguard-vpn.jpg","datePublished": "2024-11-15T00:08:00+01:00",
  "dateModified": "2024-11-15T00:08:00+01:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://bowlofbytes.com/posts/setup-wireguard-vpn/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Bowl Of Bytes",
    "logo": {
      "@type": "ImageObject",
      "url": "https://bowlofbytes.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://bowlofbytes.com/" accesskey="h" title="Bowl Of Bytes (Alt + H)">Bowl Of Bytes</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://bowlofbytes.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://bowlofbytes.com/overview/" title="Overview">
                    <span>Overview</span>
                </a>
            </li>
            <li>
                <a href="https://bowlofbytes.com/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://bowlofbytes.com/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Setting up a VPN with WireGuard
    </h1>
    <div class="post-meta"><span title='2024-11-15 00:08:00 +0100 +0100'>November 15, 2024</span>&nbsp;·&nbsp;5 min

</div>
  </header> 
<figure class="entry-cover"><img loading="eager" src="https://bowlofbytes.com/images/setup-wireguard-vpn.jpg" alt="image-setup-wireguard-vpn">
        
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#the-plan" aria-label="The plan">The plan</a></li>
                <li>
                    <a href="#wireguard-installation" aria-label="Wireguard installation">Wireguard installation</a></li>
                <li>
                    <a href="#server-configuration" aria-label="Server configuration">Server configuration</a><ul>
                        
                <li>
                    <a href="#server-interface" aria-label="Server [Interface]">Server [Interface]</a></li>
                <li>
                    <a href="#server-peer" aria-label="Server [Peer]">Server [Peer]</a></li></ul>
                </li>
                <li>
                    <a href="#client-specific-configuration" aria-label="Client specific configuration">Client specific configuration</a><ul>
                        
                <li>
                    <a href="#client-interface" aria-label="Client [Interface]">Client [Interface]</a></li>
                <li>
                    <a href="#client-peer" aria-label="Client [Peer]">Client [Peer]</a></li></ul>
                </li>
                <li>
                    <a href="#commands" aria-label="Commands">Commands</a></li>
                <li>
                    <a href="#generate-a-qr-code-to-scan" aria-label="Generate a QR code to scan">Generate a QR code to scan</a></li>
                <li>
                    <a href="#verifying-and-troubleshooting" aria-label="Verifying and troubleshooting">Verifying and troubleshooting</a><ul>
                        
                <li>
                    <a href="#1-verify-via-your-phone-or-device" aria-label="(1) Verify via your phone or device">(1) Verify via your phone or device</a></li>
                <li>
                    <a href="#2-check-if-the-vpn-still-works-after-a-reboot" aria-label="(2) Check if the VPN still works after a reboot.">(2) Check if the VPN still works after a reboot.</a></li>
                <li>
                    <a href="#-my-vpn-server-is-not-reachable-anymore" aria-label="(?) My VPN server is not reachable anymore">(?) My VPN server is not reachable anymore</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>In my project of building a homelab I wanted to set up a VPN to access my internal network from
anywhere. Read on to see how I&rsquo;ve set this up with Wireguard.</p>
<h3 id="the-plan">The plan<a hidden class="anchor" aria-hidden="true" href="#the-plan">#</a></h3>
<p>Among other devices in my network I have a Synology NAS, which I don&rsquo;t want to expose to the internet.
But I do want to be able to connect to the NAS and work on my homelab servers from outside my home.</p>
<p><img alt="VPN Setup" loading="lazy" src="/images/setup-wireguard-vpn-diagram.png" title="VPN setup"></p>
<p>I&rsquo;ve chosen <strong>Wireguard</strong> to serve as my VPN protocol. It&rsquo;s quite easy to set up and has apps available
on mobile and desktop platforms. The only thing is, you will need a static public IP address to
be able to connect. If you don&rsquo;t have that you can either use a service like <a href="https://tailscale.com/" target="_blank" rel="noopener noreferrer nofollow">TailScale</a>
or a Dynamic DNS (DDNS) service.</p>
<p>Let&rsquo;s dive into setting up <strong>Wireguard</strong> on a Debian based system, in my case a Raspberry Pi.
WireGuard is a lightweight, fast, and secure VPN protocol. You use it by installing the WireGuard app on
your phone or laptop then importing a configuration file provided by the server. Now you&rsquo;re ready to connect!</p>
<h3 id="wireguard-installation">Wireguard installation<a hidden class="anchor" aria-hidden="true" href="#wireguard-installation">#</a></h3>
<p><span style="color: #94C4FC;">→</span> Install Wireguard.</p>
<p>Let&rsquo;s also install <code>qrencode</code> to generate a QR code for the mobile client,
which can be scanned right off the terminal to add the VPN profile to the Wireguard app.</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt install wireguard qrencode -y
</span></span></code></pre></td></tr></table>
</div>
</div><p><span style="color: #94C4FC;">→</span> Create a private and public key for the server.
Don&rsquo;t share your private key with anyone.</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>mkdir vpn <span style="color:#ff6ac1">&amp;&amp;</span> cd vpn
</span></span><span style="display:flex;"><span>wg genkey <span style="color:#ff6ac1">|</span> tee server_privatekey <span style="color:#ff6ac1">|</span> wg pubkey <span style="color:#ff6ac1">&gt;</span> server_publickey
</span></span></code></pre></td></tr></table>
</div>
</div><p>A private and public key will also need to be generated for the every single client that connects via Wireguard.
I tested this via my mobile phone with the Wireguard app.</p>
<p><span style="color: #94C4FC;">→</span> Create a private and public key for the mobile client.</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>mkdir clients <span style="color:#ff6ac1">&amp;&amp;</span> cd clients
</span></span><span style="display:flex;"><span>wg genkey <span style="color:#ff6ac1">|</span> tee phone_privatekey <span style="color:#ff6ac1">|</span> wg pubkey <span style="color:#ff6ac1">&gt;</span> phone_publickey
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="server-configuration">Server configuration<a hidden class="anchor" aria-hidden="true" href="#server-configuration">#</a></h3>
<p><span style="color: #94C4FC;">→</span> Edit <code>/etc/wireguard/wg0.conf</code> and add the following configuration:</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[Interface]
</span></span><span style="display:flex;"><span>PrivateKey = &lt;server private key&gt;
</span></span><span style="display:flex;"><span>Address = 10.7.70.5/24
</span></span><span style="display:flex;"><span>ListenPort = 51820
</span></span><span style="display:flex;"><span>PostUp = iptables -A FORWARD -i wg0 -o eth0 -j ACCEPT; iptables -A FORWARD -i eth0 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span></span><span style="display:flex;"><span>PostDown = iptables -D FORWARD -i wg0 -o eth0 -j ACCEPT; iptables -D FORWARD -i eth0 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[Peer]
</span></span><span style="display:flex;"><span>PublicKey = &lt;phone public key&gt;
</span></span><span style="display:flex;"><span>AllowedIPs = 10.7.70.0/24
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Replace <server private key> and <phone public key> with the keys you generated earlier.</li>
<li>Double-check your network device name (eth0 in this case). Run <code>ip a</code> to confirm it.</li>
<li>Your VPN subnet (10.7.70.0/24) must not clash with your home subnet.</li>
<li>You can name the config anything instead of <code>wg0</code>. Just make sure you use that name everywhere instead.</li>
</ul>
<h4 id="server-interface">Server [Interface]<a hidden class="anchor" aria-hidden="true" href="#server-interface">#</a></h4>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>PrivateKey</code></td>
          <td>Paste your generated private key here.</td>
      </tr>
      <tr>
          <td><code>Address</code></td>
          <td>Subnet for your VPN, make sure this is different than your home subnet.</td>
      </tr>
      <tr>
          <td><code>ListenPort</code></td>
          <td>Port for Wireguard to work on.</td>
      </tr>
      <tr>
          <td><code>PostUp</code></td>
          <td>Enable traffic forwarding and Network Address Translation; makes sure you can access your home subnet.</td>
      </tr>
      <tr>
          <td><code>PostUp</code></td>
          <td>Remove traffic forwarding and NAT, when disabling Wireguard.</td>
      </tr>
  </tbody>
</table>
<h4 id="server-peer">Server [Peer]<a hidden class="anchor" aria-hidden="true" href="#server-peer">#</a></h4>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>PublicKey</code></td>
          <td>Paste your generated public key for your client, in our case &lsquo;phone&rsquo; here.</td>
      </tr>
      <tr>
          <td><code>AllowedIPs</code></td>
          <td>Allowed IP&rsquo;s to be assigned to client.</td>
      </tr>
  </tbody>
</table>
<p>Add multiple <code>[Peer]</code> sections for each client you want to connect to the VPN.</p>
<h3 id="client-specific-configuration">Client specific configuration<a hidden class="anchor" aria-hidden="true" href="#client-specific-configuration">#</a></h3>
<p><span style="color: #94C4FC;">→</span> Create a client configuration file, <code>phone.conf</code> in the already created <code>clients</code> directory.</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[Interface]
</span></span><span style="display:flex;"><span>PrivateKey = &lt;phone private key&gt;
</span></span><span style="display:flex;"><span>Address = 10.7.70.10/32
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[Peer]
</span></span><span style="display:flex;"><span>PublicKey = &lt;server public key&gt;
</span></span><span style="display:flex;"><span>Endpoint = &lt;your IP or public domain&gt;:51820
</span></span><span style="display:flex;"><span>AllowedIPs = 10.7.70.0/24, 192.168.0.0/24
</span></span></code></pre></td></tr></table>
</div>
</div><p>✅ This file is the one you have to distribute to your clients Wireguard app!</p>
<h4 id="client-interface">Client [Interface]<a hidden class="anchor" aria-hidden="true" href="#client-interface">#</a></h4>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>PrivateKey</code></td>
          <td>Paste your generated private key here, for your client (phone).</td>
      </tr>
      <tr>
          <td><code>Address</code></td>
          <td>Indicate the actual IP the client is going to be assigned to.</td>
      </tr>
  </tbody>
</table>
<h4 id="client-peer">Client [Peer]<a hidden class="anchor" aria-hidden="true" href="#client-peer">#</a></h4>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>PublicKey</code></td>
          <td>Paste your generated public key for your client, in our case &lsquo;phone&rsquo; here.</td>
      </tr>
      <tr>
          <td><code>Endpoint</code></td>
          <td>Put your IP or domain here. It&rsquo;s your own (external) IP.</td>
      </tr>
      <tr>
          <td><code>AllowedIPs</code></td>
          <td>IP ranges reachable by the client. In this case the VPN subnet and the home subnet.</td>
      </tr>
  </tbody>
</table>
<h3 id="commands">Commands<a hidden class="anchor" aria-hidden="true" href="#commands">#</a></h3>
<p><span style="color: #94C4FC;">→</span> Enable and start the Wireguard service based on you wg0 configuration file.</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>sudo systemctl enable wg-quick@wg0
</span></span><span style="display:flex;"><span>sudo systemctl start wg-quick@wg0
</span></span></code></pre></td></tr></table>
</div>
</div><p><span style="color: #94C4FC;">→</span> Stop Wireguard for the <code>wg0</code> configuration. This will reset the network configuration.</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>sudo wg-quick down wg0
</span></span></code></pre></td></tr></table>
</div>
</div><p><span style="color: #94C4FC;">→</span> Start Wireguard with the <code>wg0</code> configuration</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>sudo wg-quick up wg0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="generate-a-qr-code-to-scan">Generate a QR code to scan<a hidden class="anchor" aria-hidden="true" href="#generate-a-qr-code-to-scan">#</a></h3>
<p>To be able to use the VPN on your mobile phone, install the Wireguard app. You can generate a QR code in the
terminal with <code>qrencode</code>, open the app and scan the code to add the VPN profile.</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>qrencode -t ansiutf8 &lt; clients/phone.conf
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="verifying-and-troubleshooting">Verifying and troubleshooting<a hidden class="anchor" aria-hidden="true" href="#verifying-and-troubleshooting">#</a></h3>
<h4 id="1-verify-via-your-phone-or-device">(1) Verify via your phone or device<a hidden class="anchor" aria-hidden="true" href="#1-verify-via-your-phone-or-device">#</a></h4>
<p>You should be able to connect from your phone to your internal network.</p>
<ul>
<li>Turn off Wi-Fi on your phone.</li>
<li>Connect to the VPN (either by scanning the QR code on your phone or importing the configuration file).</li>
<li>Try accessing your NAS or router’s web interface.</li>
</ul>
<h4 id="2-check-if-the-vpn-still-works-after-a-reboot">(2) Check if the VPN still works after a reboot.<a hidden class="anchor" aria-hidden="true" href="#2-check-if-the-vpn-still-works-after-a-reboot">#</a></h4>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo reboot 
</span></span><span style="display:flex;"><span><span style="color:#78787e"># ...</span>
</span></span><span style="display:flex;"><span>sudo wg show
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="-my-vpn-server-is-not-reachable-anymore">(?) My VPN server is not reachable anymore<a hidden class="anchor" aria-hidden="true" href="#-my-vpn-server-is-not-reachable-anymore">#</a></h4>
<p>This is mostly due to a mis-configuration in the IP ranges in the <code>wg0.conf</code> file.</p>
<ul>
<li>Make sure the internal subnet actually matches with yours.</li>
<li>Double check if the VPN subnet is different from the internal one.</li>
</ul>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://bowlofbytes.com/tags/vpn/">VPN</a></li>
      <li><a href="https://bowlofbytes.com/tags/linux/">Linux</a></li>
      <li><a href="https://bowlofbytes.com/tags/homelab/">Homelab</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://bowlofbytes.com/">Bowl Of Bytes</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
